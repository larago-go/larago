import{Fragment as Q,computed as C,defineComponent as L,h as J,inject as X,nextTick as F,onMounted as U,onUnmounted as Y,provide as Z,ref as M,toRaw as m,watch as _,watchEffect as q}from"vue";import{Features as K,render as j,omit as W,compact as z}from'../../utils/render.js';import{useId as N}from'../../hooks/use-id.js';import{Keys as V}from'../../keyboard.js';import{calculateActiveIndex as ee,Focus as T}from'../../utils/calculate-active-index.js';import{dom as g}from'../../utils/dom.js';import{useOpenClosed as te,State as $,useOpenClosedProvider as oe}from'../../internal/open-closed.js';import{match as E}from'../../utils/match.js';import{useResolveButtonType as ne}from'../../hooks/use-resolve-button-type.js';import{useTreeWalker as le}from'../../hooks/use-tree-walker.js';import{sortByDomNode as ae}from'../../utils/focus-management.js';import{useOutsideClick as ie}from'../../hooks/use-outside-click.js';import{Hidden as ue,Features as re}from'../../internal/hidden.js';import{objectToFormEntries as se}from'../../utils/form.js';import{useControllable as de}from'../../hooks/use-controllable.js';import{useTrackedPointer as pe}from'../../hooks/use-tracked-pointer.js';import{isMobile as fe}from'../../utils/platform.js';function be(n,O){return n===O}var ve=(r=>(r[r.Open=0]="Open",r[r.Closed=1]="Closed",r))(ve||{}),ce=(r=>(r[r.Single=0]="Single",r[r.Multi=1]="Multi",r))(ce||{}),me=(r=>(r[r.Pointer=0]="Pointer",r[r.Other=1]="Other",r))(me||{});let G=Symbol("ComboboxContext");function B(n){let O=X(G,null);if(O===null){let r=new Error(`<${n} /> is missing a parent <Combobox /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(r,B),r}return O}let He=L({name:"Combobox",emits:{"update:modelValue":n=>!0},props:{as:{type:[Object,String],default:"template"},disabled:{type:[Boolean],default:!1},by:{type:[String,Function],default:()=>be},modelValue:{type:[Object,String,Number,Boolean],default:void 0},defaultValue:{type:[Object,String,Number,Boolean],default:void 0},name:{type:String},nullable:{type:Boolean,default:!1},multiple:{type:[Boolean],default:!1}},inheritAttrs:!1,setup(n,{slots:O,attrs:r,emit:P}){let e=M(1),t=M(null),p=M(null),I=M(null),s=M(null),v=M({static:!1,hold:!1}),x=M([]),S=M(null),R=M(1),y=M(!1);function A(l=u=>u){let u=S.value!==null?x.value[S.value]:null,d=ae(l(x.value.slice()),b=>g(b.dataRef.domRef)),a=u?d.indexOf(u):null;return a===-1&&(a=null),{options:d,activeOptionIndex:a}}let w=C(()=>n.multiple?1:0),o=C(()=>n.nullable),[f,c]=de(C(()=>n.modelValue===void 0?E(w.value,{[1]:[],[0]:void 0}):n.modelValue),l=>P("update:modelValue",l),C(()=>n.defaultValue)),i={comboboxState:e,value:f,mode:w,compare(l,u){if(typeof n.by=="string"){let d=n.by;return(l==null?void 0:l[d])===(u==null?void 0:u[d])}return n.by(l,u)},defaultValue:C(()=>n.defaultValue),nullable:o,inputRef:p,labelRef:t,buttonRef:I,optionsRef:s,disabled:C(()=>n.disabled),options:x,change(l){c(l)},activeOptionIndex:C(()=>{if(y.value&&S.value===null&&x.value.length>0){let l=x.value.findIndex(u=>!u.dataRef.disabled);if(l!==-1)return l}return S.value}),activationTrigger:R,optionsPropsRef:v,closeCombobox(){y.value=!1,!n.disabled&&e.value!==1&&(e.value=1,S.value=null)},openCombobox(){if(y.value=!0,n.disabled||e.value===0)return;let l=x.value.findIndex(u=>{let d=m(u.dataRef.value);return E(w.value,{[0]:()=>i.compare(m(i.value.value),m(d)),[1]:()=>m(i.value.value).some(b=>i.compare(m(b),m(d)))})});l!==-1&&(S.value=l),e.value=0},goToOption(l,u,d){if(y.value=!1,n.disabled||s.value&&!v.value.static&&e.value===1)return;let a=A();if(a.activeOptionIndex===null){let h=a.options.findIndex(H=>!H.dataRef.disabled);h!==-1&&(a.activeOptionIndex=h)}let b=ee(l===T.Specific?{focus:T.Specific,id:u}:{focus:l},{resolveItems:()=>a.options,resolveActiveIndex:()=>a.activeOptionIndex,resolveId:h=>h.id,resolveDisabled:h=>h.dataRef.disabled});S.value=b,R.value=d!=null?d:1,x.value=a.options},selectOption(l){let u=x.value.find(a=>a.id===l);if(!u)return;let{dataRef:d}=u;c(E(w.value,{[0]:()=>d.value,[1]:()=>{let a=m(i.value.value).slice(),b=m(d.value),h=a.findIndex(H=>i.compare(b,m(H)));return h===-1?a.push(b):a.splice(h,1),a}}))},selectActiveOption(){if(i.activeOptionIndex.value===null)return;let{dataRef:l,id:u}=x.value[i.activeOptionIndex.value];c(E(w.value,{[0]:()=>l.value,[1]:()=>{let d=m(i.value.value).slice(),a=m(l.value),b=d.findIndex(h=>i.compare(a,m(h)));return b===-1?d.push(a):d.splice(b,1),d}})),i.goToOption(T.Specific,u)},registerOption(l,u){let d={id:l,dataRef:u},a=A(b=>[...b,d]);if(S.value===null){let b=u.value.value;E(w.value,{[0]:()=>i.compare(m(i.value.value),m(b)),[1]:()=>m(i.value.value).some(H=>i.compare(m(H),m(b)))})&&(a.activeOptionIndex=a.options.indexOf(d))}x.value=a.options,S.value=a.activeOptionIndex,R.value=1},unregisterOption(l){var d;i.activeOptionIndex.value!==null&&((d=i.options.value[i.activeOptionIndex.value])==null?void 0:d.id)===l&&(y.value=!0);let u=A(a=>{let b=a.findIndex(h=>h.id===l);return b!==-1&&a.splice(b,1),a});x.value=u.options,S.value=u.activeOptionIndex,R.value=1}};ie([p,I,s],()=>i.closeCombobox(),C(()=>e.value===0)),Z(G,i),oe(C(()=>E(e.value,{[0]:$.Open,[1]:$.Closed})));let D=C(()=>i.activeOptionIndex.value===null?null:x.value[i.activeOptionIndex.value].dataRef.value),k=C(()=>{var l;return(l=g(p))==null?void 0:l.closest("form")});return U(()=>{_([k],()=>{if(!k.value||n.defaultValue===void 0)return;function l(){i.change(n.defaultValue)}return k.value.addEventListener("reset",l),()=>{var u;(u=k.value)==null||u.removeEventListener("reset",l)}},{immediate:!0})}),()=>{let{name:l,disabled:u,...d}=n,a={open:e.value===0,disabled:u,activeIndex:i.activeOptionIndex.value,activeOption:D.value,value:f.value};return J(Q,[...l!=null&&f.value!=null?se({[l]:f.value}).map(([b,h])=>J(ue,z({features:re.Hidden,key:b,as:"input",type:"hidden",hidden:!0,readOnly:!0,name:b,value:h}))):[],j({theirProps:{...r,...W(d,["modelValue","defaultValue","nullable","multiple","onUpdate:modelValue","by"])},ourProps:{},slot:a,slots:O,attrs:r,name:"Combobox"})])}}}),Ne=L({name:"ComboboxLabel",props:{as:{type:[Object,String],default:"label"},id:{type:String,default:()=>`headlessui-combobox-label-${N()}`}},setup(n,{attrs:O,slots:r}){let P=B("ComboboxLabel");function e(){var t;(t=g(P.inputRef))==null||t.focus({preventScroll:!0})}return()=>{let t={open:P.comboboxState.value===0,disabled:P.disabled.value},{id:p,...I}=n,s={id:p,ref:P.labelRef,onClick:e};return j({ourProps:s,theirProps:I,slot:t,attrs:O,slots:r,name:"ComboboxLabel"})}}}),Ke=L({name:"ComboboxButton",props:{as:{type:[Object,String],default:"button"},id:{type:String,default:()=>`headlessui-combobox-button-${N()}`}},setup(n,{attrs:O,slots:r,expose:P}){let e=B("ComboboxButton");P({el:e.buttonRef,$el:e.buttonRef});function t(s){e.disabled.value||(e.comboboxState.value===0?e.closeCombobox():(s.preventDefault(),e.openCombobox()),F(()=>{var v;return(v=g(e.inputRef))==null?void 0:v.focus({preventScroll:!0})}))}function p(s){switch(s.key){case V.ArrowDown:s.preventDefault(),s.stopPropagation(),e.comboboxState.value===1&&e.openCombobox(),F(()=>{var v;return(v=e.inputRef.value)==null?void 0:v.focus({preventScroll:!0})});return;case V.ArrowUp:s.preventDefault(),s.stopPropagation(),e.comboboxState.value===1&&(e.openCombobox(),F(()=>{e.value.value||e.goToOption(T.Last)})),F(()=>{var v;return(v=e.inputRef.value)==null?void 0:v.focus({preventScroll:!0})});return;case V.Escape:if(e.comboboxState.value!==0)return;s.preventDefault(),e.optionsRef.value&&!e.optionsPropsRef.value.static&&s.stopPropagation(),e.closeCombobox(),F(()=>{var v;return(v=e.inputRef.value)==null?void 0:v.focus({preventScroll:!0})});return}}let I=ne(C(()=>({as:n.as,type:O.type})),e.buttonRef);return()=>{var R,y;let s={open:e.comboboxState.value===0,disabled:e.disabled.value,value:e.value.value},{id:v,...x}=n,S={ref:e.buttonRef,id:v,type:I.value,tabindex:"-1","aria-haspopup":"listbox","aria-controls":(R=g(e.optionsRef))==null?void 0:R.id,"aria-expanded":e.disabled.value?void 0:e.comboboxState.value===0,"aria-labelledby":e.labelRef.value?[(y=g(e.labelRef))==null?void 0:y.id,v].join(" "):void 0,disabled:e.disabled.value===!0?!0:void 0,onKeydown:p,onClick:t};return j({ourProps:S,theirProps:x,slot:s,attrs:O,slots:r,name:"ComboboxButton"})}}}),$e=L({name:"ComboboxInput",props:{as:{type:[Object,String],default:"input"},static:{type:Boolean,default:!1},unmount:{type:Boolean,default:!0},displayValue:{type:Function},defaultValue:{type:String,default:void 0},id:{type:String,default:()=>`headlessui-combobox-input-${N()}`}},emits:{change:n=>!0},setup(n,{emit:O,attrs:r,slots:P,expose:e}){let t=B("ComboboxInput"),p={value:!1};e({el:t.inputRef,$el:t.inputRef});let I=C(()=>{var f;let o=t.value.value;return g(t.inputRef)?typeof n.displayValue!="undefined"&&o!==void 0?(f=n.displayValue(o))!=null?f:"":typeof o=="string"?o:"":""});U(()=>{_([I,t.comboboxState],([o,f],[c,i])=>{if(p.value)return;let D=g(t.inputRef);!D||(i===0&&f===1||o!==c)&&(D.value=o)},{immediate:!0}),_([t.comboboxState],([o],[f])=>{if(o===0&&f===1){let c=g(t.inputRef);if(!c)return;let i=c.value,{selectionStart:D,selectionEnd:k,selectionDirection:l}=c;c.value="",c.value=i,l!==null?c.setSelectionRange(D,k,l):c.setSelectionRange(D,k)}})});let s=M(!1);function v(){s.value=!0}function x(){setTimeout(()=>{s.value=!1})}function S(o){switch(p.value=!0,o.key){case V.Backspace:case V.Delete:if(t.mode.value!==0||!t.nullable.value)return;let f=o.currentTarget;requestAnimationFrame(()=>{if(f.value===""){t.change(null);let c=g(t.optionsRef);c&&(c.scrollTop=0),t.goToOption(T.Nothing)}});break;case V.Enter:if(p.value=!1,t.comboboxState.value!==0||s.value)return;if(o.preventDefault(),o.stopPropagation(),t.activeOptionIndex.value===null){t.closeCombobox();return}t.selectActiveOption(),t.mode.value===0&&t.closeCombobox();break;case V.ArrowDown:return p.value=!1,o.preventDefault(),o.stopPropagation(),E(t.comboboxState.value,{[0]:()=>t.goToOption(T.Next),[1]:()=>t.openCombobox()});case V.ArrowUp:return p.value=!1,o.preventDefault(),o.stopPropagation(),E(t.comboboxState.value,{[0]:()=>t.goToOption(T.Previous),[1]:()=>{t.openCombobox(),F(()=>{t.value.value||t.goToOption(T.Last)})}});case V.Home:if(o.shiftKey)break;return p.value=!1,o.preventDefault(),o.stopPropagation(),t.goToOption(T.First);case V.PageUp:return p.value=!1,o.preventDefault(),o.stopPropagation(),t.goToOption(T.First);case V.End:if(o.shiftKey)break;return p.value=!1,o.preventDefault(),o.stopPropagation(),t.goToOption(T.Last);case V.PageDown:return p.value=!1,o.preventDefault(),o.stopPropagation(),t.goToOption(T.Last);case V.Escape:if(p.value=!1,t.comboboxState.value!==0)return;o.preventDefault(),t.optionsRef.value&&!t.optionsPropsRef.value.static&&o.stopPropagation(),t.closeCombobox();break;case V.Tab:if(p.value=!1,t.comboboxState.value!==0)return;t.mode.value===0&&t.selectActiveOption(),t.closeCombobox();break}}function R(o){O("change",o)}function y(o){t.openCombobox(),O("change",o)}function A(){p.value=!1}let w=C(()=>{var o,f,c,i;return(i=(c=(f=n.defaultValue)!=null?f:t.defaultValue.value!==void 0?(o=n.displayValue)==null?void 0:o.call(n,t.defaultValue.value):null)!=null?c:t.defaultValue.value)!=null?i:""});return()=>{var k,l,u,d,a,b;let o={open:t.comboboxState.value===0},{id:f,displayValue:c,...i}=n,D={"aria-controls":(k=t.optionsRef.value)==null?void 0:k.id,"aria-expanded":t.disabled.value?void 0:t.comboboxState.value===0,"aria-activedescendant":t.activeOptionIndex.value===null||(l=t.options.value[t.activeOptionIndex.value])==null?void 0:l.id,"aria-labelledby":(a=(u=g(t.labelRef))==null?void 0:u.id)!=null?a:(d=g(t.buttonRef))==null?void 0:d.id,"aria-autocomplete":"list",id:f,onCompositionstart:v,onCompositionend:x,onKeydown:S,onChange:R,onInput:y,onBlur:A,role:"combobox",type:(b=r.type)!=null?b:"text",tabIndex:0,ref:t.inputRef,defaultValue:w.value};return j({ourProps:D,theirProps:i,slot:o,attrs:r,slots:P,features:K.RenderStrategy|K.Static,name:"ComboboxInput"})}}}),Ue=L({name:"ComboboxOptions",props:{as:{type:[Object,String],default:"ul"},static:{type:Boolean,default:!1},unmount:{type:Boolean,default:!0},hold:{type:[Boolean],default:!1}},setup(n,{attrs:O,slots:r,expose:P}){let e=B("ComboboxOptions"),t=`headlessui-combobox-options-${N()}`;P({el:e.optionsRef,$el:e.optionsRef}),q(()=>{e.optionsPropsRef.value.static=n.static}),q(()=>{e.optionsPropsRef.value.hold=n.hold});let p=te(),I=C(()=>p!==null?(p.value&$.Open)===$.Open:e.comboboxState.value===0);return le({container:C(()=>g(e.optionsRef)),enabled:C(()=>e.comboboxState.value===0),accept(s){return s.getAttribute("role")==="option"?NodeFilter.FILTER_REJECT:s.hasAttribute("role")?NodeFilter.FILTER_SKIP:NodeFilter.FILTER_ACCEPT},walk(s){s.setAttribute("role","none")}}),()=>{var S,R,y;let s={open:e.comboboxState.value===0},v={"aria-labelledby":(y=(S=g(e.labelRef))==null?void 0:S.id)!=null?y:(R=g(e.buttonRef))==null?void 0:R.id,id:t,ref:e.optionsRef,role:"listbox","aria-multiselectable":e.mode.value===1?!0:void 0},x=W(n,["hold"]);return j({ourProps:v,theirProps:x,slot:s,attrs:O,slots:r,features:K.RenderStrategy|K.Static,visible:I.value,name:"ComboboxOptions"})}}}),_e=L({name:"ComboboxOption",props:{as:{type:[Object,String],default:"li"},value:{type:[Object,String,Number,Boolean]},disabled:{type:Boolean,default:!1}},setup(n,{slots:O,attrs:r,expose:P}){let e=B("ComboboxOption"),t=`headlessui-combobox-option-${N()}`,p=M(null);P({el:p,$el:p});let I=C(()=>e.activeOptionIndex.value!==null?e.options.value[e.activeOptionIndex.value].id===t:!1),s=C(()=>E(e.mode.value,{[0]:()=>e.compare(m(e.value.value),m(n.value)),[1]:()=>m(e.value.value).some(o=>e.compare(m(o),m(n.value)))})),v=C(()=>({disabled:n.disabled,value:n.value,domRef:p}));U(()=>e.registerOption(t,v)),Y(()=>e.unregisterOption(t)),q(()=>{e.comboboxState.value===0&&(!I.value||e.activationTrigger.value!==0&&F(()=>{var o,f;return(f=(o=g(p))==null?void 0:o.scrollIntoView)==null?void 0:f.call(o,{block:"nearest"})}))});function x(o){if(n.disabled)return o.preventDefault();e.selectOption(t),e.mode.value===0&&e.closeCombobox(),fe()||requestAnimationFrame(()=>{var f;return(f=g(e.inputRef))==null?void 0:f.focus()})}function S(){if(n.disabled)return e.goToOption(T.Nothing);e.goToOption(T.Specific,t)}let R=pe();function y(o){R.update(o)}function A(o){!R.wasMoved(o)||n.disabled||I.value||e.goToOption(T.Specific,t,0)}function w(o){!R.wasMoved(o)||n.disabled||!I.value||e.optionsPropsRef.value.hold||e.goToOption(T.Nothing)}return()=>{let{disabled:o}=n,f={active:I.value,selected:s.value,disabled:o},c={id:t,ref:p,role:"option",tabIndex:o===!0?void 0:-1,"aria-disabled":o===!0?!0:void 0,"aria-selected":s.value,disabled:void 0,onClick:x,onFocus:S,onPointerenter:y,onMouseenter:y,onPointermove:A,onMousemove:A,onPointerleave:w,onMouseleave:w};return j({ourProps:c,theirProps:n,slot:f,attrs:r,slots:O,name:"ComboboxOption"})}}});export{He as Combobox,Ke as ComboboxButton,$e as ComboboxInput,Ne as ComboboxLabel,_e as ComboboxOption,Ue as ComboboxOptions};
